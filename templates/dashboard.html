<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Dashboard</title>
    <link rel="stylesheet" href="../static/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <a href="home.html">
        <img src="../images/home-icon.png" class="home-icon" alt="Home">
    </a>

    <h1 class="main-title">
        zomato <span class="sub-title-bold">BANGALORE</span>
    </h1>
    <h2 class="script-sub">insights dashboard</h2>

    <div style="text-align: center; margin-top: 20px;">
        <div class="section-title">summary cards</div>
    </div>

    <div style="display: flex; justify-content: center; flex-wrap: wrap;">
        <div class="dashboard-card">
            <div class="inner-dark">
                <div style="font-size: 12px; margin-bottom: 5px;">total records</div>
                <div id="total-records" style="font-size: 24px; font-weight: bold;">Loading...</div>
            </div>
        </div>
        <div class="dashboard-card">
            <div class="inner-light">
                <div style="font-size: 12px; margin-bottom: 5px;">no. of features</div>
                <div id="num-features" style="font-size: 24px; font-weight: bold;">Loading...</div>
            </div>
        </div>
        <div class="dashboard-card">
            <div class="inner-dark">
                <div style="font-size: 12px; margin-bottom: 5px;">mean rating</div>
                <div id="mean-rating" style="font-size: 24px; font-weight: bold;">Loading...</div>
            </div>
        </div>
        <div class="dashboard-card">
            <div class="inner-light">
                <div style="font-size: 12px; margin-bottom: 5px;">most common location</div>
                <div id="most-common" style="font-size: 16px; font-weight: bold;">Loading...</div>
            </div>
        </div>
    </div>

    <div style="text-align: center; margin-top: 20px;">
        <div class="section-title">charts</div>
    </div>

    <div style="display: flex; justify-content: center; flex-wrap: wrap;">
        <div class="chart-card">
            <div class="inner-dark">
                <canvas id="histogram-chart"></canvas>
            </div>
            <button class="chart-btn">histogram - rating distribution</button>
        </div>
        <div class="chart-card">
            <div class="inner-light">
                <canvas id="boxplot-chart"></canvas>
            </div>
            <button class="chart-btn">bar chart - cost by online order</button>
        </div>
        <div class="chart-card">
            <div class="inner-dark">
                <canvas id="scatter-chart"></canvas>
            </div>
            <button class="chart-btn">scatterplot - votes vs rating</button>
        </div>
        <div class="chart-card">
            <div class="inner-light">
                <canvas id="line-chart"></canvas>
            </div>
            <button class="chart-btn">lineplot - rating by cost range</button>
        </div>
    </div>

    <script>
        // Fetch dashboard insights from the API
        async function loadDashboard() {
            try {
                const response = await fetch('http://localhost:5000/api/dashboard-insights');
                const data = await response.json();

                if (data.error) {
                    console.error('Error:', data.error);
                    alert('Error loading dashboard data: ' + data.error);
                    return;
                }

                // Update summary cards
                document.getElementById('total-records').textContent = data.summary.total_records.toLocaleString();
                document.getElementById('num-features').textContent = data.summary.num_features;
                document.getElementById('mean-rating').textContent = data.summary.mean_rating + '/5';
                document.getElementById('most-common').textContent = data.summary.most_common_location;

                // Create charts
                createHistogram(data.charts.histogram);
                createBoxplot(data.charts.boxplot);
                createScatter(data.charts.scatter);
                createLineplot(data.charts.lineplot);

            } catch (error) {
                console.error('Error fetching dashboard data:', error);
                alert('Error loading dashboard. Make sure the Flask server is running on port 5000.');
            }
        }

        // Create histogram chart
        function createHistogram(data) {
            const ctx = document.getElementById('histogram-chart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'Count',
                        data: data.values,
                        backgroundColor: 'rgba(255, 99, 132, 0.6)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false },
                        title: { display: true, text: 'Rating Distribution', color: '#fff' }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: '#fff' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        x: {
                            ticks: { color: '#fff' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    }
                }
            });
        }

        // Create boxplot (using bar chart as approximation)
        function createBoxplot(data) {
            const ctx = document.getElementById('boxplot-chart').getContext('2d');

            // Calculate statistics for both groups
            const stats = {
                online_yes: calculateStats(data.online_yes),
                online_no: calculateStats(data.online_no)
            };

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Online Order: Yes', 'Online Order: No'],
                    datasets: [{
                        label: 'Average Cost',
                        data: [stats.online_yes.mean, stats.online_no.mean],
                        backgroundColor: ['rgba(54, 162, 235, 0.6)', 'rgba(255, 206, 86, 0.6)'],
                        borderColor: ['rgba(54, 162, 235, 1)', 'rgba(255, 206, 86, 1)'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false },
                        title: { display: true, text: 'Avg Cost by Online Order', color: '#003d3c' }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: '#003d3c' },
                            grid: { color: 'rgba(0, 61, 60, 0.1)' }
                        },
                        x: {
                            ticks: { color: '#003d3c' },
                            grid: { color: 'rgba(0, 61, 60, 0.1)' }
                        }
                    }
                }
            });
        }

        // Create scatter plot
        function createScatter(data) {
            const ctx = document.getElementById('scatter-chart').getContext('2d');

            const scatterData = data.x.map((x, i) => ({ x: x, y: data.y[i] }));

            new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Votes vs Rating',
                        data: scatterData,
                        backgroundColor: 'rgba(75, 192, 192, 0.6)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false },
                        title: { display: true, text: 'Votes vs Rating', color: '#fff' }
                    },
                    scales: {
                        y: {
                            title: { display: true, text: 'Rating', color: '#fff' },
                            ticks: { color: '#fff' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        x: {
                            title: { display: true, text: 'Votes', color: '#fff' },
                            ticks: { color: '#fff' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    }
                }
            });
        }

        // Create line plot
        function createLineplot(data) {
            const ctx = document.getElementById('line-chart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'Average Rating',
                        data: data.values,
                        backgroundColor: 'rgba(153, 102, 255, 0.2)',
                        borderColor: 'rgba(153, 102, 255, 1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false },
                        title: { display: true, text: 'Rating by Cost Range', color: '#003d3c' }
                    },
                    scales: {
                        y: {
                            title: { display: true, text: 'Avg Rating', color: '#003d3c' },
                            ticks: { color: '#003d3c' },
                            grid: { color: 'rgba(0, 61, 60, 0.1)' }
                        },
                        x: {
                            title: { display: true, text: 'Cost Range', color: '#003d3c' },
                            ticks: {
                                color: '#003d3c',
                                maxRotation: 45,
                                minRotation: 45
                            },
                            grid: { color: 'rgba(0, 61, 60, 0.1)' }
                        }
                    }
                }
            });
        }

        // Helper function to calculate statistics
        function calculateStats(arr) {
            if (!arr || arr.length === 0) return { mean: 0, median: 0, min: 0, max: 0 };

            const sorted = arr.slice().sort((a, b) => a - b);
            const sum = arr.reduce((a, b) => a + b, 0);

            return {
                mean: sum / arr.length,
                median: sorted[Math.floor(sorted.length / 2)],
                min: sorted[0],
                max: sorted[sorted.length - 1]
            };
        }

        // Load dashboard when page loads
        window.addEventListener('load', loadDashboard);
    </script>
</body>

</html>